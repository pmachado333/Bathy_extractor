<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Earth Vision Grid - FDPlan Input Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.10.0/dist/proj4.js"></script>
  <style>
    :root{--slb:#003366;--slb-600:#1c5991;--ink:#0b1320;--muted:#64748b;--bg:#f7f9fc;--card:#fff;--bd:#e6eef7;--ok:#0f9d58;--err:#c62828;--r:14px}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;color:var(--ink);background:var(--bg)}
    header{background:var(--slb);color:#fff;padding:14px 16px}
    header .wrap{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.2px}.sub{opacity:.9;font-size:12px}
    main{max-width:1100px;margin:18px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .content{padding:16px}
    .grid-layout{display:grid;gap:16px;grid-template-columns:1.15fr .85fr;grid-template-areas:
      "coords schematic"
      "proj right"
      "logs logs"}
    @media (max-width:979px){.grid-layout{grid-template-columns:1fr;grid-template-areas:"coords" "schematic" "proj" "right" "logs"}}
    .group{border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff}
    .coords{grid-area:coords}.schem{grid-area:schematic}.proj{grid-area:proj}.right{grid-area:right}.logs{grid-area:logs}
    h2{margin:0 0 6px;font-size:15px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    label{display:block;font-weight:600;font-size:13px;margin-bottom:6px;color:#0e2a4f}
    input[type="number"],input[type="text"]{width:100%;padding:10px 12px;border:1px solid #d7e3f4;border-radius:10px;font-size:14px;outline:none;transition:border .15s,box-shadow .15s}
    input:focus{border-color:var(--slb-600);box-shadow:0 0 0 3px rgba(28,89,145,.15)}
    .switch{display:flex;align-items:center;gap:10px;margin-top:6px}
    .desc{margin:6px 0 0;font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    button{border:none;background:var(--slb);color:#fff;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:0 8px 18px rgba(0,51,102,.25);transition:filter .15s,transform .06s}
    .secondary{background:#fff;color:var(--slb);border:1px solid #cfe1f7;box-shadow:none}
    button:hover{filter:brightness(1.05)}button:active{transform:translateY(1px)}
    .status{min-height:20px;font-size:13px;color:var(--muted)}.status.ok{color:var(--ok)}.status.err{color:var(--err)}
    pre{background:#0c1b33;color:#e7eefc;border:1px solid #243a67;border-radius:10px;padding:10px;white-space:pre;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace}
    .schematic-title{display:flex;justify-content:center}.schematic-wrap{border:1px solid var(--bd);border-radius:10px;padding:10px;background:#fbfdff}.schematic{cursor:pointer}.schematic svg{width:100%;height:auto;display:block}
    .right .stack details{border:1px solid var(--bd);border-radius:12px;padding:8px 10px;background:#fff}
    .right .stack details+details{margin-top:10px}
    .right .stack summary{list-style:none;cursor:pointer;font-weight:800;color:#0e2a4f}
    .right .stack summary::-webkit-details-marker{display:none}
    .right .stack summary:after{content:"▸";float:right;transition:transform .15s}
    .right .stack details[open] summary:after{transform:rotate(90deg)}
    .opt-compact .opt-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .opt-compact label{font-size:12px;margin-bottom:4px}.opt-compact input{padding:6px 8px;font-size:12px;border-radius:8px}.opt-compact .desc{font-size:11px;margin-top:4px}
    @media (max-width:979px){.opt-compact .opt-grid{grid-template-columns:1fr 1fr}}
    details#logs > summary{list-style:none;cursor:pointer;font-weight:800;color:#0e2a4f}
    details#logs > summary::-webkit-details-marker{display:none}
    details#logs > summary:after{content:"▸";float:right;transition:transform .15s}
    details#logs[open] > summary:after{transform:rotate(90deg)}
    #logAll{min-height:0;max-height:50vh;margin-top:8px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:saturate(120%) blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
    .panel{background:#fff;border:1px solid var(--bd);border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.25);width:min(460px,92vw);padding:16px}
    .progress{height:8px;background:#eef3fb;border-radius:999px;overflow:hidden;border:1px solid #d9e6f6}.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--slb),var(--slb-600))}
    .row{display:flex;align-items:center;justify-content:space-between;margin:10px 0 0}.ghost{background:#fff;color:var(--slb);border:1px solid #cfe1f7;box-shadow:none}
    .warn{outline:2px solid #ffcc00;animation:blink .9s 2}@keyframes blink{50%{outline-color:transparent}}

    /* ===== Compact styling only for FDPlan Upload parameters ===== */
    details#fdpParams{padding:6px 8px}
    details#fdpParams > summary{font-size:13px}
    #fdpParams label{font-size:12px;margin-bottom:4px}
    #fdpParams input[type="text"], #fdpParams input[type="number"]{padding:6px 8px;font-size:12px;border-radius:8px}
    #fdpParams .row3, #fdpParams .row2{gap:8px}
    #fdpParams .desc{font-size:11px;margin-top:4px}

    /* ===== Tiny footer attribution ===== */
    footer.tiny{max-width:1100px;margin:8px auto 20px;padding:6px 12px 0;border-top:1px solid var(--bd);font-size:10px;line-height:1.25;color:var(--muted);opacity:.9}
    footer.tiny a{color:inherit;text-decoration:underline;word-break:break-all}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div>
        <h1>Earth Vision Grid - FDPlan Input Generator</h1>
        <div class="sub">by Patrick Machado</div>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="content">
        <div class="grid-layout">
          <!-- Coordinates -->
          <div class="group coords">
            <h2>Coordinates</h2>
            <div class="row2">
              <div>
                <label for="lonStart">Longitude start</label>
                <input id="lonStart" type="number" step="0.0001" />
                <div class="desc">Western boundary (deg). Example: −44.87.</div>
              </div>
              <div>
                <label for="lonEnd">Longitude end</label>
                <input id="lonEnd" type="number" step="0.0001" />
                <div class="desc">Eastern boundary (deg). Must be ≥ start.</div>
              </div>
            </div>
            <div class="row2" style="margin-top:8px">
              <div>
                <label for="latStart">Latitude start</label>
                <input id="latStart" type="number" step="0.0001" />
                <div class="desc">Southern boundary (deg). Example: −25.85.</div>
              </div>
              <div>
                <label for="latEnd">Latitude end</label>
                <input id="latEnd" type="number" step="0.0001" />
                <div class="desc">Northern boundary (deg). Must be ≥ start.</div>
              </div>
            </div>
          </div>

          <!-- Map schematic -->
          <div class="group schem">
            <div class="schematic-title"><h2>Map schematic</h2></div>
            <div class="schematic-wrap">
              <div id="schematic" class="schematic" aria-label="Map schematic (−180..180°, −90..90°)"></div>
            </div>
            <div class="desc" style="text-align:center;margin-top:6px">Click to open Google Maps with the 4 corner pins.</div>
          </div>

          <!-- Projection + actions -->
          <div class="group proj" id="projectionBox">
            <h2>Projection</h2>
            <div class="row2">
              <div>
                <label for="zone">UTM Zone</label>
                <input id="zone" type="number" min="1" max="60" step="1" />
                <div class="desc">UTM zone (1–60). Example: 23.</div>
              </div>
              <div class="switch">
                <input id="south" type="checkbox" />
                <label for="south">South Hemisphere</label>
              </div>
            </div>

            <div class="actions">
              <button id="btnDownload" type="button" class="secondary">Download Grid File</button>
              <button id="btnRunAll" type="button">Run & Upload to FDPlan</button>
              <span id="status" class="status">Idle</span>
            </div>
          </div>

          <!-- Right column: Advanced + FDPlan params -->
          <div class="right">
            <div class="stack">
              <details id="optParams">
                <summary>Optional parameters (advanced)</summary>
                <div class="opt-compact" style="margin-top:6px">
                  <div class="opt-grid">
                    <div>
                      <label for="sample">sample</label>
                      <input id="sample" type="text" inputmode="numeric" />
                      <div class="desc">GEBCO resampling. Keep “1”.</div>
                    </div>
                    <div>
                      <label for="dxdy">Grid spacing (m)</label>
                      <input id="dxdy" type="number" min="1" step="1" />
                      <div class="desc">dx = dy in meters.</div>
                    </div>
                    <div>
                      <label for="edgeSteps">Edge offset (steps)</label>
                      <input id="edgeSteps" type="number" min="0" step="1" />
                      <div class="desc">Keeps grid inside bounds.</div>
                    </div>
                  </div>
                </div>
              </details>

              <details id="fdpParams">
                <summary>FDPlan Upload parameters</summary>
                <div style="margin-top:8px">
                  <div class="row3">
                    <div>
                      <label for="fdpName">Name</label>
                      <input id="fdpName" type="text" placeholder="Bathymetry External" />
                    </div>
                    <div>
                      <label for="fdpAppKey">App Key</label>
                      <input id="fdpAppKey" type="text" placeholder="" />
                    </div>
                    <div>
                      <label for="fdpPartition">Data Partition</label>
                      <input id="fdpPartition" type="text" placeholder="" />
                    </div>
                  </div>
                  <div class="row2" style="margin-top:8px">
                    <div>
                      <label for="fdpAuth">Authorization (key only)</label>
                      <input id="fdpAuth" type="text" placeholder="" />
                      <div class="desc">Sent as <code>authorization: Bearer &lt;key&gt;</code>.</div>
                    </div>
                    <div>
                      <label for="fdpStudyId">StudyId</label>
                      <input id="fdpStudyId" type="text" placeholder="" />
                    </div>
                  </div>
                </div>
              </details>
            </div>
          </div>

          <!-- Single log strip -->
          <div class="group logs">
            <details id="logs">
              <summary>Logs</summary>
              <pre id="logAll"></pre>
            </details>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Tiny footer attribution -->
  <footer class="tiny">
    <div>
      <strong>Attribution</strong><br>
      <em>Data source</em><br>
      GEBCO Compilation Group (2023) GEBCO 2023 Grid (doi:10.5285/f98b053b-0cbc-6c23-e053-6c86abc0af7b)<br>
      <a href="https://www.gebco.net/data_and_products/gridded_bathymetry_data/" target="_blank" rel="noopener">https://www.gebco.net/data_and_products/gridded_bathymetry_data/</a><br><br>
      <em>API provider</em><br>
      This API is compiled by Ocean Data Bank (ODB):<br>
      Ocean Data Bank, National Science and Technology Council, Taiwan. <a href="https://doi.org/10.5281/zenodo.7512112" target="_blank" rel="noopener">https://doi.org/10.5281/zenodo.7512112</a>. Retrieved 2025-10-10 from <code>api.odb.ntu.edu.tw/gebco</code>. v1.0.
    </div>
  </footer>

  <!-- Overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-live="assertive">
    <div class="panel">
      <h3 id="ovTitle">Working…</h3>
      <div class="progress" aria-hidden="true"><div id="ovBar" class="bar"></div></div>
      <div class="row">
        <div id="ovStep" style="font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#0e2a4f">Starting…</div>
        <div><button id="btnCancel" class="ghost" type="button">Cancel</button></div>
      </div>
      <div id="ovHint" class="desc" style="margin-top:8px">Keep this tab open until the upload completes.</div>
    </div>
  </div>

<script>
  const __stub={textContent:'',className:'',innerHTML:'',style:{},appendChild(){},remove(){},addEventListener(){},setAttribute(){},getAttribute(){return null;}};
  const $=id=>document.getElementById(id)||__stub;
  const safeText=(el,t)=>{if(el&&'textContent'in el)el.textContent=t};
  const safeHTML=(el,t)=>{if(el&&'innerHTML'in el)el.innerHTML=t};
  const safeClass=(el,c)=>{if(el&&'className'in el)el.className=c};
  const safeWidth=(el,w)=>{if(el&&el.style)el.style.width=w};
  const addClass=(el,c)=>{if(el&&el.classList)el.classList.add(c)};
  const remClass=(el,c)=>{if(el&&el.classList)el.classList.remove(c)};

  const SOURCE_URL='https://pmachado333.github.io/Bathy_extractor';
  const FTYPE="com.slb.cloud.fdplan.data_sources.transformation_required_test:data-types:gebco-external:Patrick Custom Solution.v1";
  const defaults={coordinates:{longitude:{start:-44.87,end:-44.48},latitude:{start:-25.85,end:-25.45}},zone:23,South:true,sample:"1",dxdy:200,edgeSteps:3,fdpName:"Bathymetry External"};
  const wait=ms=>new Promise(r=>setTimeout(r,ms));
  const nextFrame=()=>new Promise(r=>requestAnimationFrame(r));

  const els={
    lonStart:$('lonStart'),lonEnd:$('lonEnd'),latStart:$('latStart'),latEnd:$('latEnd'),
    zone:$('zone'),south:$('south'),
    sample:$('sample'),dxdy:$('dxdy'),edge:$('edgeSteps'),
    btnDownload:$('btnDownload'),btnRunAll:$('btnRunAll'),status:$('status'),
    schematic:$('schematic'),
    optParams:$('optParams'), fdpParams:$('fdpParams'),
    logAll:$('logAll'), logs:$('logs'),
    fdpName:$('fdpName'),fdpAppKey:$('fdpAppKey'),fdpPartition:$('fdpPartition'),fdpAuth:$('fdpAuth'),fdpStudyId:$('fdpStudyId'),
    overlay:$('overlay'),ovBar:$('ovBar'),ovTitle:$('ovTitle'),ovStep:$('ovStep'),btnCancel:$('btnCancel')
  };

  let controller=null,lastResult=null;

  function showOverlay(title,step,pct){els.overlay.style.display='flex';setOverlay(title,step,pct);addEventListener('beforeunload',warnUnload)}
  function hideOverlay(){els.overlay.style.display='none';removeEventListener('beforeunload',warnUnload)}
  function setOverlay(title,step,pct){if(title)safeText(els.ovTitle,title);if(step)safeText(els.ovStep,step);if(pct!=null)safeWidth(els.ovBar,Math.max(0,Math.min(100,pct))+'%')}
  function warnUnload(e){e.preventDefault();e.returnValue='Processing… please wait.'}
  els.btnCancel.addEventListener?.('click',()=>{controller?.abort();hideOverlay()});

  function setStatus(msg,kind){safeText(els.status,msg);safeClass(els.status,'status '+(kind||''));}
  function log(title, obj){
    const t=new Date().toISOString();
    els.logAll.textContent += `[${t}] ${title}\n` + (obj!=null?(typeof obj==='string'?obj:JSON.stringify(obj,null,2)):'') + `\n`;
  }

  function setDefaults(){
    els.lonStart.value=defaults.coordinates.longitude.start; els.lonEnd.value=defaults.coordinates.longitude.end;
    els.latStart.value=defaults.coordinates.latitude.start; els.latEnd.value=defaults.coordinates.latitude.end;
    els.zone.value=defaults.zone; els.south.checked=defaults.South;
    els.sample.value=defaults.sample; els.dxdy.value=defaults.dxdy; els.edge.value=defaults.edgeSteps;
    els.fdpName.value=defaults.fdpName;
    renderSchematic();
  }

  function renderSchematic(){
    const lonS=+els.lonStart.value,lonE=+els.lonEnd.value,latS=+els.latStart.value,latE=+els.latEnd.value;
    const W=640,H=320,xL=((Math.min(lonS,lonE)+180)/360)*W,xR=((Math.max(lonS,lonE)+180)/360)*W;
    const yT=((90-Math.max(latS,latE))/180)*H,yB=((90-Math.min(latS,latE))/180)*H;
    const minPix=168; const trueW=Math.max(0,xR-xL),trueH=Math.max(0,yB-yT);
    const rectW=Math.max(minPix,trueW),rectH=Math.max(minPix,trueH);
    const cx=(xL+xR)/2,cy=(yT+yB)/2; let x0=Math.min(Math.max(0,cx-rectW/2),W-rectW),y0=Math.min(Math.max(0,cy-rectH/2),H-rectH);
    const grat=[]; for(let lon=-150;lon<=150;lon+=30){const x=((lon+180)/360)*W; grat.push(`<line x1="${x}" y1="0" x2="${x}" y2="${H}" stroke="#dfe8f5"/><text x="${x}" y="${H-6}" fill="#7a8aa6" font-size="10" text-anchor="middle">${lon}°</text>`)}
    for(let lat=-60;lat<=60;lat+=30){const y=((90-lat)/180)*H; grat.push(`<line x1="0" y1="${y}" x2="${W}" y2="${y}" stroke="#dfe8f5"/><text x="6" y="${y-4}" fill="#7a8aa6" font-size="10">${lat}°</text>`)}
    const svg=`<svg viewBox="0 0 ${W} ${H}">
      <rect x="0" y="0" width="${W}" height="${H}" fill="#fff" stroke="#cddbf1"/>${grat.join('')}
      <rect x="${x0}" y="${y0}" width="${rectW}" height="${rectH}" fill="rgba(0,102,204,0.12)" stroke="#1c5991" stroke-width="2"/>
      <line x1="${x0}" y1="0" x2="${x0}" y2="${H}" stroke="#1c5991" stroke-dasharray="4,3"/>
      <line x1="${x0+rectW}" y1="0" x2="${x0+rectW}" y2="${H}" stroke="#1c5991" stroke-dasharray="4,3"/>
      <line x1="0" y1="${y0}" x2="${W}" y2="${y0}" stroke="#1c5991" stroke-dasharray="4,3"/>
      <line x1="0" y1="${y0+rectH}" x2="${W}" y2="${y0+rectH}" stroke="#1c5991" stroke-dasharray="4,3"/>
      <g font-size="11" fill="#0e2a4f" font-weight="600">
        <text x="${x0+4}" y="${Math.max(12,y0-8)}">Lon start</text>
        <text x="${Math.max(4,x0+rectW-56)}" y="${Math.max(12,y0-8)}">Lon end</text>
        <text x="${Math.min(W-90,x0+6)}" y="${y0+14}">Lat end</text>
        <text x="${Math.min(W-90,x0+6)}" y="${y0+rectH-6}">Lat start</text>
      </g>
    </svg>`;
    safeHTML(els.schematic,svg);
  }
  function openGoogleMapsPins(){
    const lonStart=+els.lonStart.value,lonEnd=+els.lonEnd.value,latStart=+els.latStart.value,latEnd=+els.latEnd.value;
    const west=Math.min(lonStart,lonEnd),east=Math.max(lonStart,lonEnd),south=Math.min(latStart,latEnd),north=Math.max(latStart,latEnd);
    const SW=`${south.toFixed(6)},${west.toFixed(6)}`,NW=`${north.toFixed(6)},${west.toFixed(6)}`,NE=`${north.toFixed(6)},${east.toFixed(6)}`,SE=`${south.toFixed(6)},${east.toFixed(6)}`;
    const url4=`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(SW)}&destination=${encodeURIComponent(NE)}&waypoints=${encodeURIComponent(NW)}|${encodeURIComponent(SE)}`;
    const url2=`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(SW)}&destination=${encodeURIComponent(NE)}`;
    const w=open(url4,'_blank','noopener'); if(!w||w.closed||typeof w.closed==='undefined') open(url2,'_blank','noopener');
  }
  $('schematic').addEventListener?.('click',openGoogleMapsPins);
  let _t; ['input','change'].forEach(ev=>[els.lonStart,els.lonEnd,els.latStart,els.latEnd].forEach(i=>i.addEventListener?.(ev,()=>{clearTimeout(_t);_t=setTimeout(renderSchematic,60)}, {passive:true})));

  function buildRing({lonStart,lonEnd,latStart,latEnd}){return [[lonStart,latStart],[lonStart,latEnd],[lonEnd,latEnd],[lonEnd,latStart],[lonStart,latStart]]}
  function buildUrl(sample,ring){const poly={type:'Polygon',coordinates:[ring]};const jsonsrc=encodeURIComponent(JSON.stringify(poly));return `https://api.odb.ntu.edu.tw/gebco?mode=Polygon&sample=${encodeURIComponent(String(sample))}&jsonsrc=${jsonsrc}`;}
  async function callApi(url,signal){const r=await fetch(url,{headers:{accept:'application/json'},signal});if(!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);const t=await r.text();try{return JSON.parse(t)}catch{return t}}
  function makeAxisInner(min,max,step,edge){const eps=1e-9,pad=Math.max(0,edge|0)*step;const s=min+pad,e=max-pad,vals=[];if(e-s<=step+eps) return {vals:[],startBound:s,endBound:e};for(let v=s;v<=e-step-eps;v+=step) vals.push(v);return {vals,startBound:s,endBound:e}}
  function knnIndices(pts,qx,qy,k=12){const d=pts.map((p,i)=>[i,(p[0]-qx)**2+(p[1]-qy)**2]);d.sort((a,b)=>a[1]-b[1]);return d.slice(0,Math.min(k,d.length)).map(x=>x[0])}
  function idwInterpolate(pts,vals,qx,qy,k=12,power=2,eps=1e-12){const idx=knnIndices(pts,qx,qy,k);let num=0,den=0;for(const i of idx){const dx=pts[i][0]-qx,dy=pts[i][1]-qy,d2=dx*dx+dy*dy;if(d2<eps) return vals[i];const w=1/Math.pow(d2,power/2);num+=w*vals[i];den+=w}return den>0?num/den:NaN}
  function gaussianKernel1D(sigma){const r=Math.max(1,Math.floor(sigma*3));const k=[];let s=0,s2=2*sigma*sigma;for(let i=-r;i<=r;i++){const v=Math.exp(-(i*i)/s2);k.push(v);s+=v}return k.map(v=>v/s)}
  function normalizeApiData(d){
    if(d&&Array.isArray(d.longitude)&&Array.isArray(d.latitude)&&Array.isArray(d.z)){
      const L=Math.min(d.longitude.length,d.latitude.length,d.z.length);
      return Array.from({length:L},(_,i)=>({longitude:+d.longitude[i],latitude:+d.latitude[i],Z:+d.z[i],distance:d.distance?(+d.distance[i]||0):0}));
    }
    if(Array.isArray(d)&&d.length){
      if(Array.isArray(d[0])) return d.map(r=>({longitude:+r[0],latitude:+r[1],Z:+r[2],distance:+(r[3]||0)}));
      if(typeof d[0]==='object') return d.map(o=>({longitude:+(o.longitude??o.lon??o[0]),latitude:+(o.latitude??o.lat??o[1]),Z:+(o.Z??o.z??o[2]),distance:+(o.distance??o[3]??0)}));
    }
    throw new Error('Unexpected API format (need longitude[], latitude[], z[]).')
  }
  async function processDataAsync({apiData,zone,South,dxdy,edgeSteps},update){
    const rows=normalizeApiData(apiData);
    const utm=`+proj=utm +zone=${zone} ${South?'+south':''} +datum=WGS84 +units=m +no_defs`, proj=proj4('WGS84',utm);
    update('Projecting…',8);
    for(let i=0;i<rows.length;i++){const xy=proj.forward([rows[i].longitude,rows[i].latitude]);rows[i].X=xy[0];rows[i].Y=xy[1]; if(i%2000===0) await nextFrame();}
    const dx=dxdy,dy=dxdy,xmin=Math.min(...rows.map(r=>r.X)),xmax=Math.max(...rows.map(r=>r.X)),ymin=Math.min(...rows.map(r=>r.Y)),ymax=Math.max(...rows.map(r=>r.Y));
    const axX=makeAxisInner(xmin,xmax,dx,edgeSteps),axY=makeAxisInner(ymin,ymax,dy,edgeSteps); const x_vals=axX.vals,y_vals=axY.vals;
    if(!x_vals.length||!y_vals.length) throw new Error('No interior grid after edge offset. Reduce offset/spacing.');
    const pts=rows.map(r=>[r.X,r.Y]),vals=rows.map(r=>r.Z),W=x_vals.length,H=y_vals.length; let Z=new Float64Array(W*H);
    update('Gridding (IDW)…',22);
    for(let j=0;j<H;j++){const y=y_vals[j];for(let i=0;i<W;i++){const x=x_vals[i];let z=idwInterpolate(pts,vals,x,y,12,2);if(Number.isNaN(z)) z=vals[0];Z[j*W+i]=z;} if(j%2===0) await nextFrame();}
    const ker=gaussianKernel1D(5),r=(ker.length-1)/2,tmp=new Float64Array(Z.length),out=new Float64Array(Z.length);
    update('Smoothing X…',60);
    for(let y=0;y<H;y++){for(let x=0;x<W;x++){let a=0;for(let i=-r;i<=r;i++){const xx=Math.min(W-1,Math.max(0,x+i));a+=ker[i+r]*Z[y*W+xx];} tmp[y*W+x]=a;} if(y%4===0) await nextFrame();}
    update('Smoothing Y…',74);
    for(let y=0;y<H;y++){for(let x=0;x<W;x++){let a=0;for(let j=-r;j<=r;j++){const yy=Math.min(H-1,Math.max(0,y+j));a+=ker[j+r]*tmp[yy*W+x];} out[y*W+x]=a;} if(y%4===0) await nextFrame();}
    Z=out;
    update('Building output…',90);
    const grid=[]; for(let rI=0;rI<H;rI++){const y=y_vals[rI];for(let cI=0;cI<W;cI++){const x=x_vals[cI];grid.push([+x.toFixed(4),+y.toFixed(4),Z[rI*W+cI],cI+1,rI+1]);} if(rI%8===0) await nextFrame();}
    grid.sort((a,b)=>(a[4]-b[4])||(a[3]-b[3]));
    const x0=+axX.startBound.toFixed(4),x1=+axX.endBound.toFixed(4),y0=+axY.startBound.toFixed(4),y1=+axY.endBound.toFixed(4);
    const header=`# Type: scattered data
# Version: 6
# Description: No description
# Format: free
# Field: 1 x
# Field: 2 y
# Field: 3 z meters
# Field: 4 column
# Field: 5 row
# Projection: Local Rectangular
# Units: meters
# End:
# Information from grid:
# Grid_size: ${x_vals.length} x ${y_vals.length}
# Grid_space: ${x0},${x1},${y0},${y1}
# Scattered data: Not_available
# Z_field: z
# Vertical_faults: Not_available
# History: No history
# Z_units: meters
`;
    const csv=grid.map(r=>`${r[0]} ${r[1]} ${r[2]} ${r[3]} ${r[4]}`).join('\n');
    return {finalText:header+csv,preview:grid.slice(0,30).map(r=>`${r[0]} ${r[1]} ${r[2].toFixed(3)} ${r[3]} ${r[4]}`).join('\n'),
      dims:{x:x_vals.length,y:y_vals.length},bounds:{xmin:x0,xmax:x1,ymin:y0,ymax:y1}};
  }

  async function computeBathymetry(){
    const lonStart=+els.lonStart.value,lonEnd=+els.lonEnd.value,latStart=+els.latStart.value,latEnd=+els.latEnd.value,zone=+els.zone.value,South=!!els.south.checked;
    if([lonStart,lonEnd,latStart,latEnd,zone].some(Number.isNaN)) throw new Error('All fields must be numbers.');
    if(lonStart>lonEnd) throw new Error('Longitude start ≤ end.');
    if(latStart>latEnd) throw new Error('Latitude start ≤ end.');
    if(zone<1||zone>60) throw new Error('UTM zone 1..60.');
    controller?.abort(); controller=new AbortController();
    showOverlay('GEBCO','Calling…',2);
    const apiURL=buildUrl((els.sample.value||'1'),buildRing({lonStart,lonEnd,latStart,latEnd}));
    const apiData=await callApi(apiURL, controller.signal);
    log('GEBCO URL', apiURL);
    log('GEBCO response', apiData);
    const res=await processDataAsync({apiData,zone,South,dxdy:Math.max(1,+els.dxdy.value||200),edgeSteps:Math.max(0,Math.floor(+els.edge.value||3))},(s,p)=>setOverlay('Processing',s,p));
    log('Processed preview (first 30 rows)', res.preview);
    lastResult=res; setStatus('Ready','ok'); return res;
  }

  $('btnDownload')?.addEventListener('click', async()=>{
    try{
      showOverlay('Preparing file…','Checking',8);
      if(!lastResult) await computeBathymetry();
      setOverlay('Preparing download…','Creating file',96); await nextFrame();
      const blob=new Blob([lastResult.finalText],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='updated_bathymetry_data_LATLONG.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
      setOverlay('Done','Download started',100); setTimeout(hideOverlay,400);
    }catch(e){ setStatus(e?.message||String(e),'err'); hideOverlay(); }
  });

  const mask=s=>!s?'':(s.trim().length<=10?s.slice(0,3)+'***':s.slice(0,6)+'…'+s.slice(-4));
  function normalizeToken(input){ if(!input) return ''; let t=String(input).trim(); if(/^bearer\s+/i.test(t)) t=t.replace(/^bearer\s+/i,'').trim(); return t; }
  function buildHeaders({authKey,appKey,partition,contentType}){ const h={'authorization':`Bearer ${authKey}`,'appkey':appKey,'slb-data-partition-id':partition,'accept':'*/*'}; if(contentType) h['content-type']=contentType; return h; }
  function logRequest({method,url,headers,body}){const u=new URL(url); const safe={...headers}; if(safe.authorization) safe.authorization='Bearer '+mask(String(safe.authorization).replace(/^Bearer\s+/i,'')); if(safe.appkey) safe.appkey=mask(safe.appkey); log(`→ ${method} ${u.pathname}`,{host:u.host,headers:safe,body});}

  function readCreds({strict=true}={}){
    const appKey=(els.fdpAppKey.value||'').trim();
    const partition=(els.fdpPartition.value||'').trim();
    const authKey=normalizeToken(els.fdpAuth.value||'');
    const name=(els.fdpName.value||'Bathymetry External').trim();
    const studyId=(els.fdpStudyId.value||'').trim();
    if(strict){
      const missing=[];
      if(!appKey) missing.push('App Key');
      if(!partition) missing.push('Data Partition');
      if(!authKey) missing.push('Authorization');
      if(!studyId) missing.push('StudyId');
      if(missing.length){
        els.fdpParams.open = true;
        addClass(els.fdpParams,'warn'); setTimeout(()=>remClass(els.fdpParams,'warn'),1200);
        throw new Error(`Cannot run: ${missing.join(', ')} required.`);
      }
    }
    return {appKey,partition,authKey,name,studyId};
  }
  function ensureFileReady(){ if(!lastResult||!lastResult.finalText) throw new Error('No generated content.'); }
  function buildMultipartFromFile(file){
    const boundary='X-INSOMNIA-BOUNDARY',CRLF='\r\n';
    const head=`--${boundary}${CRLF}Content-Disposition: form-data; name="uploadFile"; filename="${file.name}"${CRLF}Content-Type: ${file.type||'text/plain'}${CRLF}${CRLF}`;
    const tail=`${CRLF}--${boundary}--${CRLF}`;
    const body=new Blob([head,file,tail]);
    return {body,contentType:`multipart/form-data; boundary=${boundary}`};
  }

  async function fdpPostJob({name,appKey,partition,authKey,studyId}){
    const url='https://br1.api.delfi.slb.com/fdplan/data-sources/v2/data-source-jobs/';
    const payload={name,description:`Generated ${new Date().toISOString()}`,source:{type:'test:data-types:gebco-external',store:'Patrick Custom Solution'},target:{type:'earth-vision-grid'},tags:[`StudyId:${studyId}`],dataProviders:{items:[{name:'Github',sources:[SOURCE_URL],description:'Dumy test'}]}};
    const headers=buildHeaders({authKey,appKey,partition,contentType:'application/json'});
    logRequest({method:'POST',url,headers,body:payload});
    const res=await fetch(url,{method:'POST',headers,body:JSON.stringify(payload)});
    const text=await res.text(); let data; try{data=JSON.parse(text)}catch{data=text}
    log(`← ${res.status} job create`,data);
    if(!res.ok) throw new Error(`Job create failed: ${res.status} ${res.statusText}`);
    if(!data||!data.id) throw new Error('Missing job id.');
    return data.id;
  }

  async function fdpFetchContainer({jobId,appKey,partition,authKey}){
    const url=`https://br1.api.delfi.slb.com/fdplan/events/alpha/v1/cloud-events?type=${encodeURIComponent(FTYPE)}`;
    const headers=buildHeaders({authKey,appKey,partition});
    await wait(3000);
    for(let attempt=1;attempt<=30;attempt++){
      logRequest({method:'GET',url,headers});
      const res=await fetch(url,{headers});
      const text=await res.text(); let data; try{data=JSON.parse(text)}catch{data=text}
      log(`← ${res.status} events attempt ${attempt}`,data);
      if(res.ok && data && Array.isArray(data.events)){
        const evt=data.events.find(e=>e?.data?.id===jobId);
        if(evt){
          const containers=evt?.data?.details?.containers||[];
          const path=(containers[0]&&containers[0].path)||null;
          if(path){ const containerID=path.replace(/\//g,'%2F'); log('Found container',{path,containerID}); return containerID; }
          log('No container yet for job; retrying…',{attempt});
        } else { log('Job event not found yet; retrying…',{attempt}); }
      }
      await wait(3000);
    }
    throw new Error('Container path not found after polling.');
  }

  async function fdpUpload({containerID,appKey,partition,authKey}){
    ensureFileReady();
    const file=new File([lastResult.finalText],'updated_bathymetry_data_LATLONG.txt',{type:'text/plain'});
    const {body,contentType}=buildMultipartFromFile(file);
    const url=`https://br1.api.delfi.slb.com/fdplan/evaluation/v1/containers/${containerID}/files`;
    const headers=buildHeaders({authKey,appKey,partition,contentType});
    logRequest({method:'POST',url,headers,body:{multipart:true,field:'uploadFile',filename:file.name,size:file.size,type:file.type}});
    const res=await fetch(url,{method:'POST',headers,body});
    const text=await res.text(); let data; try{data=JSON.parse(text)}catch{data=text}
    log(`← ${res.status} upload`,data);
    if(!res.ok){const err=new Error(`Upload failed: ${res.status}`); err.status=res.status; err.response=data; throw err;}
    return data;
  }

  async function fdpUploadWithRetry({containerID,appKey,partition,authKey,jobId}){
    for(let attempt=1;attempt<=5;attempt++){
      try{ log(`Upload attempt ${attempt}`,{containerID}); const r=await fdpUpload({containerID,appKey,partition,authKey}); return r; }
      catch(e){
        log(`Upload attempt ${attempt} failed`,{message:e?.message,status:e?.status,body:e?.response});
        if(e?.status===400||e?.status===404){ await wait(3000); const newCID=await fdpFetchContainer({jobId,appKey,partition,authKey}); containerID=newCID; continue; }
        throw e;
      }
    }
    throw new Error('Upload failed after retries.');
  }

  async function fdpSetState({jobId,appKey,partition,authKey}){
    const url=`https://br1.api.delfi.slb.com/fdplan/data-sources/alpha/v2/data-source-jobs/${encodeURIComponent(jobId)}/state`;
    const headers=buildHeaders({authKey,appKey,partition,contentType:'application/json'});
    const body={state:'TransformationCompleted'};
    logRequest({method:'POST',url,headers,body});
    const res=await fetch(url,{method:'POST',headers,body:JSON.stringify(body)});
    const text=await res.text(); let data; try{data=JSON.parse(text)}catch{data=text}
    log(`← ${res.status} set state`,data);
    if(!res.ok) throw new Error(`Set state failed: ${res.status} ${res.statusText}`);
    return data;
  }

  $('btnRunAll')?.addEventListener('click', async()=>{
    try{
      const creds=readCreds({strict:true});

      showOverlay('GEBCO','Build grid…',2);
      if(!lastResult) await computeBathymetry();

      setOverlay('FDPlan','Create job…',35);
      const jobId=await fdpPostJob(creds); log('jobId', jobId);

      setOverlay('FDPlan','Get container…',55);
      const containerID=await fdpFetchContainer({jobId,...creds}); log('containerID', containerID);

      setOverlay('FDPlan','Upload file…',75);
      await fdpUploadWithRetry({containerID,jobId,...creds});

      setOverlay('FDPlan','Set state…',90);
      await fdpSetState({jobId,...creds});

      setOverlay('Done','Completed',100);
      setStatus('FDPlan upload completed.','ok');
    }catch(e){
      setStatus(e?.message||String(e),'err');
    }finally{
      setTimeout(hideOverlay,900);
    }
  });

  function init(){
    setDefaults();
    safeText($('status'),'Idle');
  }
  init();
</script>
</body>
</html>
